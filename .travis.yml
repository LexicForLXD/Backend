dist: trusty
sudo: required

language: php
php:
  - '7.1'
  - '7.2'

services:
  - postgresql
  - redis-server

before_install:
  - sudo apt update
  - php -m
  - cd /usr/local/src/
  - sudo wget https://libssh2.org/download/libssh2-1.8.0.tar.gz
  - sudo tar -xzf libssh2-1.8.0.tar.gz
  - cd libssh2-1.8.0
  - sudo ./configure
  - sudo make all install
  - cd
  - echo "extension = ssh2.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
  - echo "extension = redis.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
  - php -m

install:
  - sudo apt --yes install snapd
  - sudo snap install lxd
  - composer install --no-interaction


before_script:
  - psql -c 'create database travis_ci_test;' -U postgres
  - cp app/config/parameters.yml.travis app/config/parameters.yml
  - php bin/console doctrine:database:create --env=test
  - php bin/console doctrine:schema:create --env=test
  - php bin/console doctrine:fixtures:load -n --env=test

stages:
  - test
  - name: release
    if: branch = master
  - name: deploy
    if: branch = master


jobs:
  include:
    - stage: test
      script: phpunit
